################ get_project_metadata.ps1
function Get-ProjectMetadata {
  <#
    .SYNOPSIS
    Get metadata for a Chef Software, Inc. project
    .DESCRIPTION
    Get metadata for project
    .EXAMPLE
    iex (new-object net.webclient).downloadstring('<%= base_url || "https://chefdownload-commercial.chef.io" %>/install.ps1<%= base_url && base_url.include?("chefdownload") ? "?license_id=$env:CHEF_LICENSE_KEY" : "" %>'); Get-ProjectMetadata -project chef -channel stable

    Gets the download url and SHA256 checksum for the latest stable release of Chef.
    .EXAMPLE
    iex (irm '<%= base_url || "https://chefdownload-commercial.chef.io" %>/install.ps1<%= base_url && base_url.include?("chefdownload") ? "?license_id=$env:CHEF_LICENSE_KEY" : "" %>'); Get-ProjectMetadata -project chef-workstation -channel stable
  #>
  [cmdletbinding()]
  param (
    # Base url to retrieve metadata from.
    [uri]
    $base_server_uri,
    [string]
    # Project to install
    [string]
    $project = '<%= default_product %>',
    # Version of the application to install
    # This parameter is optional, if not supplied it will provide the latest version,
    # and if an iteration number is not specified, it will grab the latest available iteration.
    # Partial version numbers are also acceptable (using v=11
    # will grab the latest 11.x client which matches the other flags).
    [string]
    $version,
    # Release channel to install from
    [validateset('current', 'stable', 'unstable')]
    [string]
    $channel = 'stable',
    # The following legacy switches are just aliases for the current channel
    [switch]
    $prerelease,
    [switch]
    $nightlies,
    [validateset('auto', 'i386', 'x86_64')]
    [string]
    $architecture = 'auto',
    # License ID for commercial API access
    [string]
    $license_id <%= "= '#{license_id}'" if license_id && !license_id.to_s.empty? %>
  )

  # The following legacy switches are just aliases for the current channel
  if (($prerelease -eq $true)) { $channel = 'current'}
  if (($nightlies -eq $true)) { $channel = 'current'}

  # PowerShell is only on Windows ATM
  $platform = 'windows'
  Write-Host "Platform: $platform"

  $platform_version = Get-PlatformVersion
  Write-Host "Platform Version: $platform_version"

  if ($architecture -eq 'auto') {
    $architecture = Get-PlatformArchitecture
  }

  Write-Host "Architecture: $architecture"
  Write-Host "Project: $project"

<% if base_url && !base_url.to_s.empty? %>
  # Set base_server_uri from option if not already set via parameter
  if ([string]::IsNullOrEmpty($base_server_uri)) {
    $base_server_uri = "<%= base_url %>"
  }
<% end %>

  if ([string]::IsNullOrEmpty($base_server_uri)) {
    if (-not [string]::IsNullOrEmpty($license_id)) {
      # Check if license_id starts with 'free-' or 'trial-' for trial API
      if ($license_id -match '^(free-|trial-)') {
        # Trial API endpoint
        $base_server_uri = "<%= Mixlib::Install::Dist::TRIAL_API_ENDPOINT %>"
      }
      else {
        # Commercial API endpoint
        $base_server_uri = "<%= Mixlib::Install::Dist::COMMERCIAL_API_ENDPOINT %>"
      }
    }
    else {
      # Omnitruck endpoint
      $base_server_uri = "<%= Mixlib::Install::Dist::OMNITRUCK_ENDPOINT %>"
    }
  }

  # For chef-ice product, add platform (p), machine (m), and package_manager (pm) parameters
  if (-not [string]::IsNullOrEmpty($license_id)) {
    if ($project -eq "chef-ice") {
      $package_manager = "msi"
      $platform_param = "windows"
      $metadata_url = "$base_server_uri$channel/$project/metadata?license_id=$license_id&v=$version&m=$architecture&p=$platform_param&pm=$package_manager"
    }
    else {
      # For other products, use standard parameters
      $metadata_url = "$base_server_uri$channel/$project/metadata?license_id=$license_id&v=$version&p=$platform&pv=$platform_version&m=$architecture"
    }
  }
  else {
    # Omnitruck URL parameters without license_id
    $metadata_url = "$base_server_uri$channel/$project/metadata?v=$version&p=$platform&pv=$platform_version&m=$architecture"
  }

  Write-Host "Downloading $project details from $metadata_url"
  $response = (Get-WebContent $metadata_url).trim()

  # Commercial and trial APIs return JSON, omnitruck returns text format
  if ($license_id) {
    # Parse JSON response from commercial/trial API
    try {
      $json = $response | ConvertFrom-Json
      $package_metadata = @{
        url = $json.url
        sha256 = $json.sha256
        version = $json.version
      }
      if ($json.sha1) {
        $package_metadata['sha1'] = $json.sha1
      }
    } catch {
      throw "Failed to parse JSON response from API: $_"
    }
  } else {
    # Parse text response from omnitruck
    $package_metadata = $response -split '\n' |
      foreach { $hash = @{} } {$key, $value = $_ -split '\s+'; $hash.Add($key, $value)} {$hash}
  }

  Write-Host "Project details: "
  foreach ($key in $package_metadata.keys) {
    Write-Host "`t$key = $($package_metadata[$key])"
  }
  $package_metadata
}
