function Get-ProjectFileName {
  <#
    .SYNOPSIS
    Get filename for a Chef Software, Inc. project package
    .DESCRIPTION
    Get the actual filename for a project package from the download API
    .EXAMPLE
    Get-ProjectFileName -project chef -channel stable -version latest

    Gets the filename for the latest stable release of Chef.
  #>
  [cmdletbinding()]
  param (
    # Base url to retrieve filename from.
    [uri]$base_server_uri = '<%= omnitruck_endpoint %>',
    # Project to install
    [string]
    $project = 'chef',
    # Version of the application to install
    [string]
    $version,
    # Release channel to install from
    [validateset('current', 'stable', 'unstable')]
    [string]
    $channel = 'stable',
    # The following legacy switches are just aliases for the current channel
    [switch]
    $prerelease,
    [switch]
    $nightlies,
    [validateset('auto', 'i386', 'x86_64')]
    [string]
    $architecture = 'auto',
    # Package manager type
    [validateset('msi', 'pm')]
    [string]
    $package_manager,
    # License ID for commercial API access
    [string]
    $license_id
  )

  # The following legacy switches are just aliases for the current channel
  if (($prerelease -eq $true)) { $channel = 'current'}
  if (($nightlies -eq $true)) { $channel = 'current'}

  # PowerShell is only on Windows ATM
  $platform = 'windows'
  Write-Verbose "Platform: $platform"

  $platform_version = Get-PlatformVersion
  Write-Verbose "Platform Version: $platform_version"

  if ($architecture -eq 'auto') {
    $architecture = Get-PlatformArchitecture
  }

  Write-Verbose "Architecture: $architecture"
  Write-Verbose "Project: $project"

  # Validate unsupported projects
  if ($project -eq 'migrate-ice') {
    throw "The project 'migrate-ice' is not supported by this script."
  }

  # Use commercial API if license_id is provided, otherwise use omnitruck
  if ($license_id) {
    # Check if license_id starts with 'free-' or 'trial-' for trial API
    $base_server_uri = '<%= omnitruck_endpoint %>'
  }

  $filename_base_url = "/$($channel)/$($project)/filename"

  # chef-ice uses different parameters
  if ($project -eq 'chef-ice') {
    $filename_array = @(
      "?v=$($version)",
      "p=$platform",
      "m=$architecture",
      "pm=msi"
    )
  } else {
    $filename_array = @(
      "?v=$($version)",
      "p=$platform",
      "pv=$platform_version",
      "m=$architecture"
    )
  }

  # Add license_id to query parameters if provided
  if ($license_id) {
    $filename_array += "license_id=$license_id"
  }

  $filename_base_url += [string]::join('&', $filename_array)
  $filename_url = new-uri $base_server_uri $filename_base_url

  Write-Verbose "Downloading $project filename from $filename_url"
  $response = (Get-WebContent $filename_url).trim()

  # Commercial and trial APIs return JSON, omnitruck returns text format
  if ($license_id) {
    # Parse JSON response from commercial/trial API
    try {
      $json = $response | ConvertFrom-Json
      $package_filename = @{
        filename = $json.filename
      }
    } catch {
      throw "Failed to parse JSON response from API: $_"
    }
  } else {
    # Parse text response from omnitruck (if needed in future)
    # For now, omnitruck doesn't have a filename endpoint
    throw "Filename endpoint requires license_id parameter"
  }

  Write-Verbose "Filename: $($package_filename.filename)"
  $package_filename
}
