# fetch_metadata.sh
############
# This section calls omnitruck to get the information about the build to be
#   installed.
#
# Inputs:
# $channel:
# $project:
# $version:
# $platform:
# $platform_version:
# $machine:
# $tmp_dir:
# $license_id
# $package_manager:
# Outputs:
# $download_url:
# $sha256:
############

if test "x$download_url_override" = "x"; then
  echo "Getting information for $project $channel $version for $platform..."

  metadata_filename="$tmp_dir/metadata.txt"

  # Use commercial API if license_id is provided, otherwise use omnitruck
  if test "x$license_id" != "x"; then
    if [ ${project} = "chef-ice" ]; then
      metadata_url="<%= omnitruck_endpoint %>/$channel/$project/metadata?v=$version&p=$platform&m=$machine&pm=$package_manager&license_id=$license_id"
    else
      metadata_url="<%= omnitruck_endpoint %>/$channel/$project/metadata?v=$version&p=$platform&pv=$platform_version&m=$machine&license_id=$license_id"
    fi
  else
    # Omnitruck endpoint
    metadata_url="<%= base_url %>/$channel/$project/metadata?v=$version&p=$platform&pv=$platform_version&m=$machine"
  fi

  do_download "$metadata_url"  "$metadata_filename"
  meta_response=$(cat "$metadata_filename")
  modify_response $meta_response $metadata_filename
  cat "$metadata_filename"

  # check that all the mandatory fields in the downloaded metadata are there
  if grep '^url' $metadata_filename > /dev/null && grep '^sha256' $metadata_filename > /dev/null; then
    echo "downloaded metadata file looks valid..."
  else
    echo "downloaded metadata file is corrupted or an uncaught error was encountered in downloading the file..."
    # this generally means one of the download methods downloaded a 404 or something like that and then reported a successful exit code,
    # and this should be fixed in the function that was doing the download.
    report_bug
    exit 1
  fi

  download_url=`awk '$1 == "url" { print $2 }' "$metadata_filename"`
  sha256=`awk '$1 == "sha256" { print $2 }' "$metadata_filename"`
else
  download_url=$download_url_override
  # Set sha256 to empty string if checksum not set
  sha256=${checksum=""}
fi

############
# end of fetch_metadata.sh
############
