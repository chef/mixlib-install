# fetch_metadata.sh
############
# This section calls omnitruck to get the information about the build to be
#   installed.
#
# Inputs:
# $channel:
# $project:
# $version:
# $platform:
# $platform_version:
# $machine:
# $tmp_dir:
#
# Outputs:
# $download_url:
# $sha256:
############

if [ -z "$download_url_override" ]; then
  echo "Getting information for $project $channel $version for $platform..."

  metadata_filename="$tmp_dir/metadata.txt"

  # Use commercial API if license_id is provided, otherwise use omnitruck
  if [ -n "$license_id" ]; then
    # Check if license_id starts with 'free-' or 'trial-' for trial API
    case "$license_id" in
      free-*|trial-*)
        # Trial API endpoint
        base_api_url="https://chefdownload-trial.chef.io"
        ;;
      *)
        # Commercial API endpoint
        base_api_url="https://chefdownload-commercial.chef.io"
        ;;
    esac
    metadata_url="$base_api_url/$channel/$project/metadata?v=$version&p=$platform&pv=$platform_version&m=$machine&license_id=$license_id"
  else
    # Omnitruck endpoint
    metadata_url="<%= base_url %>/$channel/$project/metadata?v=$version&p=$platform&pv=$platform_version&m=$machine"
  fi

  do_download "$metadata_url"  "$metadata_filename"

  cat "$metadata_filename"

  echo ""

  # Commercial and trial APIs return JSON, omnitruck returns text format
  if [ -n "$license_id" ]; then
    # Parse JSON response from commercial/trial API
    # Check if response looks like JSON
    if grep -q '^{' "$metadata_filename" 2>/dev/null; then
      # Extract url and sha256 from JSON
      # Try using sed for simple JSON parsing (more portable than jq)
      download_url=`sed -n 's/.*"url":"\([^"]*\)".*/\1/p' "$metadata_filename"`
      sha256=`sed -n 's/.*"sha256":"\([^"]*\)".*/\1/p' "$metadata_filename"`

      if [ -n "$download_url" ] && [ -n "$sha256" ]; then
        echo "downloaded metadata file looks valid..."
      else
        echo "downloaded metadata file is corrupted or an uncaught error was encountered in downloading the file..."
        report_bug
        exit 1
      fi
    else
      echo "downloaded metadata file is corrupted or an uncaught error was encountered in downloading the file..."
      report_bug
      exit 1
    fi
  else
    # Parse text response from omnitruck
    if grep '^url' $metadata_filename > /dev/null && grep '^sha256' $metadata_filename > /dev/null; then
      echo "downloaded metadata file looks valid..."
      download_url=`awk '$1 == "url" { print $2 }' "$metadata_filename"`
      sha256=`awk '$1 == "sha256" { print $2 }' "$metadata_filename"`
    else
      echo "downloaded metadata file is corrupted or an uncaught error was encountered in downloading the file..."
      # this generally means one of the download methods downloaded a 404 or something like that and then reported a successful exit code,
      # and this should be fixed in the function that was doing the download.
      report_bug
      exit 1
    fi
  fi
else
  download_url=$download_url_override
  # Set sha256 to checksum value if provided, empty otherwise
  sha256="${checksum:-}"
fi

############
# end of fetch_metadata.sh
############
